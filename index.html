<script>
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const captureBtn = document.getElementById("capture");
const downloadBtn = document.getElementById("download");
const nameInput = document.getElementById("nameInput");

let photos = [];

/* ===== AKTIFKAN KAMERA BELAKANG ===== */
async function startCamera(){
  try{
    const stream = await navigator.mediaDevices.getUserMedia({
      video:{
        facingMode:{ ideal:"environment" }, // ðŸ‘ˆ kamera belakang
        width:{ ideal:1280 },
        height:{ ideal:720 }
      },
      audio:false
    });
    video.srcObject = stream;
  }catch(e){
    alert("Kamera tidak bisa diakses");
    console.error(e);
  }
}
startCamera();

/* ===== AMBIL FOTO ===== */
captureBtn.onclick=()=>{
  if(photos.length>=3) return;

  const temp=document.createElement("canvas");
  temp.width=video.videoWidth;
  temp.height=video.videoHeight;
  temp.getContext("2d").drawImage(video,0,0);
  photos.push(temp);

  if(photos.length===3){
    createStrip();
    downloadBtn.style.display="inline-block";
  }
};

/* ===== BACKGROUND GRID ===== */
function drawGrid(){
  ctx.fillStyle="#ffc1d9";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  ctx.strokeStyle="rgba(255,255,255,0.35)";
  ctx.lineWidth=2;

  for(let x=0;x<canvas.width;x+=40){
    ctx.beginPath();
    ctx.moveTo(x,0);
    ctx.lineTo(x,canvas.height);
    ctx.stroke();
  }
  for(let y=0;y<canvas.height;y+=40){
    ctx.beginPath();
    ctx.moveTo(0,y);
    ctx.lineTo(canvas.width,y);
    ctx.stroke();
  }
}

/* ===== FOTO TANPA GEPENG ===== */
function drawPhotoCover(img,x,y,w,h){
  const ir=img.width/img.height;
  const fr=w/h;
  let sx,sy,sw,sh;

  if(ir>fr){
    sh=img.height;
    sw=sh*fr;
    sx=(img.width-sw)/2;
    sy=0;
  }else{
    sw=img.width;
    sh=sw/fr;
    sx=0;
    sy=(img.height-sh)/2;
  }
  ctx.drawImage(img,sx,sy,sw,sh,x,y,w,h);
}

/* ===== BINTANG PUTIH ===== */
function drawStar(x,y,r){
  ctx.beginPath();
  for(let i=0;i<10;i++){
    const a=Math.PI/5*i;
    const rr=i%2===0?r:r/2;
    ctx.lineTo(x+Math.cos(a)*rr,y+Math.sin(a)*rr);
  }
  ctx.closePath();
  ctx.fillStyle="white";
  ctx.fill();
}

/* ===== PESAWAT KERTAS ===== */
function drawPaperPlane(x,y,s){
  ctx.beginPath();
  ctx.moveTo(x,y);
  ctx.lineTo(x+s,y+s/2);
  ctx.lineTo(x,y+s);
  ctx.lineTo(x+s/4,y+s/2);
  ctx.closePath();
  ctx.fillStyle="white";
  ctx.fill();
}

/* ===== STRIP FOTO ===== */
function createStrip(){
  const stripW=900;
  const photoW=520;
  const photoH=700;
  const gap=40;

  canvas.width=stripW;
  canvas.height=160 + (photoH+gap)*3 + 200;

  drawGrid();

  /* COUPLE TEXT */
  ctx.font="54px Pacifico";
  ctx.fillStyle="#ff3d8b";
  ctx.textAlign="center";
  ctx.fillText("Couple ðŸ’•", stripW/2, 90);

  /* BINTANG & PESAWAT */
  drawStar(60,80,14);
  drawStar(stripW-60,120,12);
  drawPaperPlane(20,canvas.height/2,45);
  drawPaperPlane(stripW-65,canvas.height/2-40,45);

  /* FOTO */
  let y=140;
  photos.forEach(p=>{
    ctx.fillStyle="white";
    ctx.fillRect((stripW-photoW)/2-15,y-15,photoW+30,photoH+30);
    drawPhotoCover(p,(stripW-photoW)/2,y,photoW,photoH);
    y+=photoH+gap;
  });

  /* NAMA & TANGGAL */
  const name=nameInput.value||"Couple ðŸ’‘";
  const date=new Date().toLocaleDateString("id-ID");

  ctx.font="42px Pacifico";
  ctx.fillStyle="#ff3d8b";
  ctx.fillText(name, stripW/2, canvas.height-90);

  ctx.font="24px Arial";
  ctx.fillText(date, stripW/2, canvas.height-50);
}

/* ===== DOWNLOAD ===== */
downloadBtn.onclick=()=>{
  const a=document.createElement("a");
  a.download="photobooth-couple-strip.png";
  a.href=canvas.toDataURL();
  a.click();
};
</script>
